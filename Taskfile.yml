version: '3'

vars:
  DIST_DIR: ./dist
  GRAMMAR_BUILD_DIR: .grammar-build

includes:
  web:
    taskfile: ./web/Taskfile.yml
    dir: ./web

tasks:
  #############################################################################
  # Grammar patching for Rust (override crates.io with local builds)
  #############################################################################

  grammar:clone:
    internal: true
    desc: Clone a grammar repo for local patching
    requires:
      vars: [REPO]
    vars:
      REF: '{{.REF | default "master"}}'
      REPO_NAME: '{{base .REPO}}'
    cmds:
      - mkdir -p {{.GRAMMAR_BUILD_DIR}}
      - |
        cd {{.GRAMMAR_BUILD_DIR}}
        rm -rf "{{.REPO_NAME}}"
        echo "Cloning {{.REPO}} ({{.REF}})..."
        git clone --depth 1 --branch {{.REF}} "https://github.com/{{.REPO}}.git" "{{.REPO_NAME}}"

  grammar:patch:
    desc: "Patch a Rust grammar with local build. Usage: task grammar:patch CRATE=tree-sitter-c-sharp REPO=tree-sitter/tree-sitter-c-sharp"
    requires:
      vars: [CRATE, REPO]
    vars:
      REF: '{{.REF | default "master"}}'
      REPO_NAME: '{{base .REPO}}'
    cmds:
      - task: grammar:clone
        vars: { REPO: "{{.REPO}}", REF: "{{.REF}}" }
      - |
        # Add [patch.crates-io] section if it doesn't exist
        if ! grep -q '^\[patch\.crates-io\]' Cargo.toml; then
          echo "" >> Cargo.toml
          echo "# Local grammar patches (managed by: task grammar:patch)" >> Cargo.toml
          echo "[patch.crates-io]" >> Cargo.toml
        fi

        # Remove existing patch for this crate if present
        sed -i '/^{{.CRATE}} = { path/d' Cargo.toml

        # Add the patch
        echo '{{.CRATE}} = { path = "{{.GRAMMAR_BUILD_DIR}}/{{.REPO_NAME}}" }' >> Cargo.toml
        echo "Patched {{.CRATE}} -> {{.GRAMMAR_BUILD_DIR}}/{{.REPO_NAME}}"

  grammar:unpatch:
    desc: "Remove a local grammar patch. Usage: task grammar:unpatch CRATE=tree-sitter-c-sharp"
    requires:
      vars: [CRATE]
    cmds:
      - |
        if grep -q '^{{.CRATE}} = { path' Cargo.toml; then
          sed -i '/^{{.CRATE}} = { path/d' Cargo.toml
          echo "Removed patch for {{.CRATE}}"
        else
          echo "No patch found for {{.CRATE}}"
        fi

  grammar:unpatch-all:
    desc: Remove all local grammar patches
    cmds:
      - |
        # Remove all path-based patches and the section header if empty
        sed -i '/^tree-sitter-.* = { path/d' Cargo.toml
        sed -i '/^# Local grammar patches/d' Cargo.toml
        # Remove empty [patch.crates-io] section
        sed -i '/^\[patch\.crates-io\]$/{ N; /^\[patch\.crates-io\]\n$/d }' Cargo.toml
        echo "Removed all grammar patches"

  grammar:patch-csharp:
    desc: Patch C# grammar with latest from source (has C# 12 primary constructor fix)
    cmds:
      - task: grammar:patch
        vars:
          CRATE: tree-sitter-c-sharp
          REPO: tree-sitter/tree-sitter-c-sharp

  grammar:list-patches:
    desc: List currently patched grammars
    cmds:
      - |
        echo "Current grammar patches:"
        grep '^tree-sitter-.* = { path' Cargo.toml 2>/dev/null || echo "  (none)"

  # === tractor (Rust XPath CLI) ===

  build:
    desc: Build tractor (release)
    cmds:
      - cargo build --release -p tractor

  install:
    desc: Build and install tractor to ~/.cargo/bin
    cmds:
      - cargo install --path tractor

  run:
    desc: Run tractor with arguments
    cmds:
      - cargo run --release -p tractor -- {{.CLI_ARGS}}

  test:
    desc: Run all tests (Rust, TypeScript, integration)
    cmds:
      - cargo test --workspace
      - task: web:test
      - task: test:snapshots
      - task: test:integration

  test:integration:
    desc: Run integration tests
    deps: [build]
    cmds:
      - bash tests/integration/test.sh

  test:snapshots:
    desc: Regenerate XML snapshots and verify they match committed versions
    deps: [build]
    cmds:
      - bash tests/integration/test_snapshots.sh

  # === Distribution builds ===

  dist:linux:
    desc: Build for Linux (via Docker)
    cmds:
      - mkdir -p {{.DIST_DIR}}/linux-x64
      - docker build -t tractor-builder -f Dockerfile.build .
      - docker run --rm -v "{{.PWD}}:/src" tractor-builder
          cargo build --release --target x86_64-unknown-linux-gnu
      - cp target/x86_64-unknown-linux-gnu/release/tractor {{.DIST_DIR}}/linux-x64/
    vars:
      PWD:
        sh: pwd

  dist:windows:
    desc: Build for Windows (native)
    cmds:
      - mkdir -p {{.DIST_DIR}}/windows-x64
      - cargo build --release
      - cp target/release/tractor.exe {{.DIST_DIR}}/windows-x64/

  # === Maintenance ===

  clean:
    desc: Clean build artifacts
    cmds:
      - rm -rf dist/
      - rm -rf target/
      - task: web:clean
