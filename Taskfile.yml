version: '3'

vars:
  DIST_DIR: ./dist

includes:
  web:
    taskfile: ./web/Taskfile.yml
    dir: ./web

tasks:
  #############################################################################
  # Grammar patching (override crates.io with git repos)
  #############################################################################

  grammar:patch:
    desc: "Patch a grammar with a git repo. Usage: task grammar:patch CRATE=tree-sitter-c-sharp REPO=tree-sitter/tree-sitter-c-sharp"
    requires:
      vars: [CRATE, REPO]
    cmds:
      - |
        # Add [patch.crates-io] section if it doesn't exist
        if ! grep -q '^\[patch\.crates-io\]' Cargo.toml; then
          echo "" >> Cargo.toml
          echo "# Grammar patches (managed by: task grammar:patch)" >> Cargo.toml
          echo "[patch.crates-io]" >> Cargo.toml
        fi

        # Remove existing patch for this crate if present (git or legacy path)
        sed -i '/^{{.CRATE}} = { git/d' Cargo.toml
        sed -i '/^{{.CRATE}} = { path/d' Cargo.toml
        # Clean up legacy comment if present
        sed -i '/^# Local grammar patches/d' Cargo.toml

        # Add the git patch (Cargo.lock pins the exact commit)
        echo '{{.CRATE}} = { git = "https://github.com/{{.REPO}}" }' >> Cargo.toml
        echo "Patched {{.CRATE}} -> {{.REPO}} (run cargo update -p {{.CRATE}} to refresh)"

  grammar:unpatch:
    desc: "Remove a grammar patch. Usage: task grammar:unpatch CRATE=tree-sitter-c-sharp"
    requires:
      vars: [CRATE]
    cmds:
      - |
        if grep -q '^{{.CRATE}} = { git' Cargo.toml; then
          sed -i '/^{{.CRATE}} = { git/d' Cargo.toml
          echo "Removed patch for {{.CRATE}}"
        elif grep -q '^{{.CRATE}} = { path' Cargo.toml; then
          sed -i '/^{{.CRATE}} = { path/d' Cargo.toml
          echo "Removed legacy path patch for {{.CRATE}}"
        else
          echo "No patch found for {{.CRATE}}"
        fi

  grammar:unpatch-all:
    desc: Remove all grammar patches
    cmds:
      - |
        sed -i '/^tree-sitter-.* = { git/d' Cargo.toml
        sed -i '/^tree-sitter-.* = { path/d' Cargo.toml
        sed -i '/^# Grammar patches/d' Cargo.toml
        sed -i '/^\[patch\.crates-io\]$/{ N; /^\[patch\.crates-io\]\n$/d }' Cargo.toml
        echo "Removed all grammar patches"

  grammar:patch-csharp:
    desc: Patch C# grammar with latest from source (has C# 12 primary constructor fix)
    cmds:
      - task: grammar:patch
        vars:
          CRATE: tree-sitter-c-sharp
          REPO: tree-sitter/tree-sitter-c-sharp

  grammar:list-patches:
    desc: List currently patched grammars
    cmds:
      - |
        echo "Current grammar patches:"
        grep -E '^tree-sitter-.* = \{ (git|path)' Cargo.toml 2>/dev/null || echo "  (none)"

  # === tractor (Rust XPath CLI) ===

  build:
    desc: Build tractor (release)
    cmds:
      - cargo build --release -p tractor

  install:
    desc: Build and install tractor to ~/.cargo/bin
    cmds:
      - cargo install --path tractor

  run:
    desc: Run tractor with arguments
    cmds:
      - cargo run --release -p tractor -- {{.CLI_ARGS}}

  test:
    desc: Run all tests (Rust, TypeScript, integration)
    cmds:
      - cargo test --workspace
      - task: web:test
      - task: test:snapshots
      - task: test:integration

  test:integration:
    desc: Run integration tests
    deps: [build]
    cmds:
      - bash tests/integration/test.sh

  test:snapshots:
    desc: Regenerate XML snapshots and verify they match committed versions
    deps: [build]
    cmds:
      - bash tests/integration/test_snapshots.sh

  # === Distribution builds ===

  dist:linux:
    desc: Build for Linux (via Docker)
    cmds:
      - mkdir -p {{.DIST_DIR}}/linux-x64
      - docker build -t tractor-builder -f Dockerfile.build .
      - docker run --rm -v "{{.PWD}}:/src" tractor-builder
          cargo build --release --target x86_64-unknown-linux-gnu
      - cp target/x86_64-unknown-linux-gnu/release/tractor {{.DIST_DIR}}/linux-x64/
    vars:
      PWD:
        sh: pwd

  dist:windows:
    desc: Build for Windows (native)
    cmds:
      - mkdir -p {{.DIST_DIR}}/windows-x64
      - cargo build --release
      - cp target/release/tractor.exe {{.DIST_DIR}}/windows-x64/

  # === Maintenance ===

  clean:
    desc: Clean build artifacts
    cmds:
      - rm -rf dist/
      - rm -rf target/
      - task: web:clean
