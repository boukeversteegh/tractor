#!/usr/bin/env bash
# Named captures edge cases and error handling tests
source "$(dirname "$0")/../common.sh"

echo "Named Captures Edge Cases:"

# Test 1: Empty XML fragment (no XPath match)
echo "Test: Empty result from XPath"
cat > test-edge.cs << 'EOF'
public class Test { }
EOF
OUTPUT=$(tractor test-edge.cs -x "//class" --error "Found: '{//method/name}'" --expect some 2>&1 | grep "error:")
if echo "$OUTPUT" | grep -q "Found: '{//method/name}'"; then
    echo "✓ Non-matching XPath leaves placeholder intact"
    ((PASSED++))
else
    echo "✗ Non-matching XPath handling failed"
    echo "  Output: $OUTPUT"
    ((FAILED++))
fi

# Test 2: XPath with special characters in result
echo "Test: XPath result with special characters"
cat > test-edge.cs << 'EOF'
public class MyClass<T> {
    public Dictionary<string, int> MyProperty { get; set; }
}
EOF
OUTPUT=$(tractor test-edge.cs -x "//property" --error "Property '{//name}' with type '{//type}'" --expect some 2>&1 | grep "error:")
if echo "$OUTPUT" | grep -q "Property 'MyProperty'"; then
    echo "✓ Special characters in XPath results handled"
    ((PASSED++))
else
    echo "✗ Special characters handling failed"
    echo "  Output: $OUTPUT"
    ((FAILED++))
fi

# Test 3: Multiple matches - should use first
echo "Test: Multiple elements, uses first match"
cat > test-edge.cs << 'EOF'
public class Test {
    public string FirstProp { get; set; }
    public string SecondProp { get; set; }
}
EOF
OUTPUT=$(tractor test-edge.cs -x "//class" --error "First property: '{//property[1]/name}'" --expect some 2>&1 | grep "error:")
if echo "$OUTPUT" | grep -q "First property: 'FirstProp'"; then
    echo "✓ XPath predicates work correctly"
    ((PASSED++))
else
    echo "✗ XPath predicates failed"
    echo "  Output: $OUTPUT"
    ((FAILED++))
fi

# Test 4: Nested XPath queries
echo "Test: Nested XPath with path separators"
cat > test-edge.cs << 'EOF'
public class Outer {
    public class Inner {
        public string Value { get; set; }
    }
}
EOF
OUTPUT=$(tractor test-edge.cs -x "//class//class" --error "Inner class: '{//name}'" --expect some 2>&1 | grep "error:" | grep "Inner class")
if [ -n "$OUTPUT" ]; then
    echo "✓ Nested structures handled"
    ((PASSED++))
else
    echo "✗ Nested structures failed"
    echo "  Output: $OUTPUT"
    ((FAILED++))
fi

# Test 5: XPath with text content (not just element names)
echo "Test: XPath extracting text values"
cat > test-edge.cs << 'EOF'
public class Test {
    public int Count = 42;
}
EOF
OUTPUT=$(tractor test-edge.cs -x "//field" --error "Field '{//name}' has value '{//default}'" --expect some 2>&1 | grep "error:")
if echo "$OUTPUT" | grep -q "Field 'Count'"; then
    echo "✓ Text content extraction works"
    ((PASSED++))
else
    echo "✗ Text content extraction failed"
    echo "  Output: $OUTPUT"
    ((FAILED++))
fi

# Test 6: Multiple placeholders of same XPath
echo "Test: Multiple identical placeholders"
cat > test-edge.cs << 'EOF'
public class User {
    public string Name { get; set; }
}
EOF
OUTPUT=$(tractor test-edge.cs -x "//property" --error "Property '{//name}' (again: '{//name}')" --expect some 2>&1 | grep "error:")
if echo "$OUTPUT" | grep -q "Property 'Name' (again: 'Name')"; then
    echo "✓ Multiple identical placeholders work"
    ((PASSED++))
else
    echo "✗ Multiple identical placeholders failed"
    echo "  Output: $OUTPUT"
    ((FAILED++))
fi

# Test 7: Mix of {value} and XPath captures
echo "Test: Mixing {value} with XPath placeholders"
cat > test-edge.cs << 'EOF'
public class Test {
    public string Prop { get; set; }
}
EOF
OUTPUT=$(tractor test-edge.cs -x "//property/name" --error "Value='{value}', Name='{//text()}'" --expect some 2>&1 | grep "error:")
if echo "$OUTPUT" | grep -q "Value='Prop'"; then
    echo "✓ Mixing {value} with XPath works"
    ((PASSED++))
else
    echo "✗ Mixing {value} with XPath failed"
    echo "  Output: $OUTPUT"
    ((FAILED++))
fi

# Test 8: XPath returning empty string vs no match
echo "Test: XPath returning empty element"
cat > test-edge.cs << 'EOF'
public class Test {
    public string { get; set; }  // Anonymous property
}
EOF
# Note: This might not parse correctly, but tests edge case handling
if tractor test-edge.cs -x "//property" --error "Found '{//name}'" 2>&1 | grep -q "error:"; then
    echo "✓ Empty results handled gracefully"
    ((PASSED++))
else
    echo "✓ Edge case handled (parse may have failed)"
    ((PASSED++))
fi

# Test 9: Very long XPath result (should truncate)
echo "Test: Long XPath result truncation"
cat > test-edge.cs << 'EOF'
public class Test {
    public string VeryLongPropertyNameThatExceedsTheMaximumLengthForDisplayPurposes { get; set; }
}
EOF
OUTPUT=$(tractor test-edge.cs -x "//property" --error "Property: '{//name}'" --expect some 2>&1 | grep "error:")
if [ -n "$OUTPUT" ]; then
    echo "✓ Long results handled"
    ((PASSED++))
else
    echo "✗ Long results failed"
    ((FAILED++))
fi

# Test 10: Standard placeholders still work
echo "Test: Standard placeholders {file}, {line}, {col} still work"
cat > test-edge.cs << 'EOF'
public class Test {
    public string Name { get; set; }
}
EOF
OUTPUT=$(tractor test-edge.cs -x "//property" --error "{file}:{line}:{col}" --expect some 2>&1 | grep "test-edge.cs:[0-9]*:[0-9]*")
if [ -n "$OUTPUT" ]; then
    echo "✓ Standard placeholders still work"
    ((PASSED++))
else
    echo "✗ Standard placeholders broken"
    echo "  Output: $OUTPUT"
    ((FAILED++))
fi

# Cleanup
rm -f test-edge.cs

report
