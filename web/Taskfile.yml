version: '3'

vars:
  GRAMMARS_DIR: public/grammars
  GRAMMARS_TS_DIR: src/grammars
  BUILD_DIR: .grammar-build

tasks:
  #############################################################################
  # Grammar source tasks (internal) - each generates a TS import file
  #############################################################################

  grammar:from-npm:
    internal: true
    desc: Install npm package and generate TS import
    requires:
      vars: [LANG, PACKAGE, WASM_FILE]
    cmds:
      - npm install --save-dev {{.PACKAGE}}
      - mkdir -p {{.GRAMMARS_TS_DIR}}
      - |
        cat > "{{.GRAMMARS_TS_DIR}}/{{.LANG}}.ts" << 'EOF'
        // Auto-generated by: task grammar:from-npm LANG={{.LANG}} PACKAGE={{.PACKAGE}}
        // @ts-ignore
        import wasm from '{{.PACKAGE}}/{{.WASM_FILE}}.wasm?url';
        export default wasm;
        EOF
      - echo "Generated {{.GRAMMARS_TS_DIR}}/{{.LANG}}.ts (npm:{{.PACKAGE}})"

  grammar:from-release:
    internal: true
    desc: Download WASM from GitHub release and generate TS import
    requires:
      vars: [LANG, REPO, VERSION, WASM_FILE]
    vars:
      OUT_FILE: '{{.OUT_FILE | default .WASM_FILE}}'
    cmds:
      - mkdir -p {{.GRAMMARS_DIR}} {{.GRAMMARS_TS_DIR}}
      - |
        url="https://github.com/{{.REPO}}/releases/download/{{.VERSION}}/{{.WASM_FILE}}.wasm"
        echo "Downloading {{.WASM_FILE}}.wasm from $url..."
        curl -fsSL "$url" -o "{{.GRAMMARS_DIR}}/{{.OUT_FILE}}.wasm"
      - |
        cat > "{{.GRAMMARS_TS_DIR}}/{{.LANG}}.ts" << 'EOF'
        // Auto-generated by: task grammar:from-release LANG={{.LANG}} REPO={{.REPO}} VERSION={{.VERSION}}
        // @ts-ignore
        import wasm from '/grammars/{{.OUT_FILE}}.wasm?url';
        export default wasm;
        EOF
      - echo "Generated {{.GRAMMARS_TS_DIR}}/{{.LANG}}.ts (release:{{.REPO}}@{{.VERSION}})"

  grammar:from-source:
    internal: true
    desc: Build WASM from source and generate TS import
    deps: [setup:tree-sitter-cli]
    requires:
      vars: [LANG, REPO]
    vars:
      REF: '{{.REF | default "master"}}'
      REPO_NAME: '{{base .REPO}}'
    cmds:
      - mkdir -p {{.BUILD_DIR}} {{.GRAMMARS_DIR}} {{.GRAMMARS_TS_DIR}}
      - |
        cd {{.BUILD_DIR}}
        rm -rf "{{.REPO_NAME}}"
        echo "Cloning {{.REPO}} ({{.REF}})..."
        git clone --depth 1 --branch {{.REF}} "https://github.com/{{.REPO}}.git" "{{.REPO_NAME}}"
      - |
        cd {{.BUILD_DIR}}/{{.REPO_NAME}}
        echo "Building WASM for {{.REPO_NAME}}..."
        tree-sitter build --wasm
        WASM_FILE=$(ls -1 *.wasm 2>/dev/null | head -1)
        if [ -n "$WASM_FILE" ]; then
          cp "$WASM_FILE" "../../{{.GRAMMARS_DIR}}/"
          echo "Copied $WASM_FILE to {{.GRAMMARS_DIR}}/"
          # Generate TS file
          cat > "../../{{.GRAMMARS_TS_DIR}}/{{.LANG}}.ts" << EOF
        // Auto-generated by: task grammar:from-source LANG={{.LANG}} REPO={{.REPO}} REF={{.REF}}
        // @ts-ignore
        import wasm from '/grammars/$WASM_FILE?url';
        export default wasm;
        EOF
          echo "Generated {{.GRAMMARS_TS_DIR}}/{{.LANG}}.ts (source:{{.REPO}})"
        else
          echo "ERROR: No .wasm file generated"
          exit 1
        fi

  grammar:generate-index:
    internal: true
    desc: Generate index.ts that re-exports all grammar modules
    cmds:
      - |
        cd {{.GRAMMARS_TS_DIR}}
        echo "// Auto-generated by: task grammar:generate-index" > index.ts
        echo "// Re-exports all grammar WASM URLs" >> index.ts
        echo "" >> index.ts
        for f in *.ts; do
          if [ "$f" != "index.ts" ]; then
            lang="${f%.ts}"
            echo "export { default as $lang } from './$lang';" >> index.ts
          fi
        done
        echo "Generated {{.GRAMMARS_TS_DIR}}/index.ts"

  setup:tree-sitter-cli:
    internal: true
    desc: Install tree-sitter CLI (via cargo)
    status:
      - command -v tree-sitter
    cmds:
      - echo "Installing tree-sitter CLI..."
      - cargo install tree-sitter-cli

  #############################################################################
  # Master grammar task - SOURCE OF TRUTH for each language
  #############################################################################

  grammars:
    desc: Fetch all grammar WASM files and generate TS imports
    cmds:
      # tree-sitter runtime (special case - no TS file needed)
      - npm install --save-dev web-tree-sitter

      # JavaScript - npm
      - task: grammar:from-npm
        vars: { LANG: javascript, PACKAGE: tree-sitter-javascript, WASM_FILE: tree-sitter-javascript }

      # TypeScript - npm
      - task: grammar:from-npm
        vars: { LANG: typescript, PACKAGE: tree-sitter-typescript, WASM_FILE: tree-sitter-typescript }

      # TSX - npm
      - task: grammar:from-npm
        vars: { LANG: tsx, PACKAGE: tree-sitter-typescript, WASM_FILE: tree-sitter-tsx }

      # Python - npm
      - task: grammar:from-npm
        vars: { LANG: python, PACKAGE: tree-sitter-python, WASM_FILE: tree-sitter-python }

      # Rust - npm
      - task: grammar:from-npm
        vars: { LANG: rust, PACKAGE: tree-sitter-rust, WASM_FILE: tree-sitter-rust }

      # Go - npm
      - task: grammar:from-npm
        vars: { LANG: go, PACKAGE: tree-sitter-go, WASM_FILE: tree-sitter-go }

      # C - npm
      - task: grammar:from-npm
        vars: { LANG: c, PACKAGE: tree-sitter-c, WASM_FILE: tree-sitter-c }

      # C++ - npm
      - task: grammar:from-npm
        vars: { LANG: cpp, PACKAGE: tree-sitter-cpp, WASM_FILE: tree-sitter-cpp }

      # Java - npm
      - task: grammar:from-npm
        vars: { LANG: java, PACKAGE: tree-sitter-java, WASM_FILE: tree-sitter-java }

      # Ruby - npm
      - task: grammar:from-npm
        vars: { LANG: ruby, PACKAGE: tree-sitter-ruby, WASM_FILE: tree-sitter-ruby }

      # JSON - npm
      - task: grammar:from-npm
        vars: { LANG: json, PACKAGE: tree-sitter-json, WASM_FILE: tree-sitter-json }

      # HTML - npm
      - task: grammar:from-npm
        vars: { LANG: html, PACKAGE: tree-sitter-html, WASM_FILE: tree-sitter-html }

      # CSS - npm
      - task: grammar:from-npm
        vars: { LANG: css, PACKAGE: tree-sitter-css, WASM_FILE: tree-sitter-css }

      # Bash - npm
      - task: grammar:from-npm
        vars: { LANG: bash, PACKAGE: tree-sitter-bash, WASM_FILE: tree-sitter-bash }

      # PHP - npm
      - task: grammar:from-npm
        vars: { LANG: php, PACKAGE: tree-sitter-php, WASM_FILE: tree-sitter-php }

      # C# - BUILD FROM SOURCE (npm v0.23.1 lacks C# 12 primary constructor support)
      - task: grammar:from-source
        vars: { LANG: csharp, REPO: tree-sitter/tree-sitter-c-sharp }

      # Generate index.ts that re-exports all grammars
      - task: grammar:generate-index

  #############################################################################
  # Convenience tasks for individual languages
  #############################################################################

  grammar:build-csharp:
    desc: Rebuild C# grammar from latest source
    cmds:
      - task: grammar:from-source
        vars: { LANG: csharp, REPO: tree-sitter/tree-sitter-c-sharp }

  #############################################################################
  # Build tasks
  #############################################################################

  wasm:
    desc: Build tractor-core to WASM
    cmds:
      - cd ../tractor-core && wasm-pack build --target web --no-default-features --features wasm
      - cp -r ../tractor-core/pkg ./

  install:
    desc: Install npm dependencies
    cmds:
      - npm install

  check:
    desc: Type check TypeScript
    cmds:
      - npx tsc --noEmit

  test:
    desc: Run vitest tests
    cmds:
      - npx vitest run

  dev:
    desc: Run dev server
    deps: [wasm]
    cmds:
      - npm run dev

  build:
    desc: Build for production (GitHub Pages)
    deps: [wasm]
    cmds:
      - npm run build

  build:fly:
    desc: Build for Fly.io deployment (base=/)
    deps: [wasm]
    cmds:
      - MSYS_NO_PATHCONV=1 npx vite build --base=/

  deploy:fly:
    desc: Build and deploy to Fly.io
    cmds:
      - task: build:fly
      - fly deploy

  preview:
    desc: Preview production build
    cmds:
      - npm run preview

  clean:
    desc: Clean web build artifacts
    cmds:
      - rm -rf pkg/
      - rm -rf dist/
      - rm -rf node_modules/
      - rm -rf {{.BUILD_DIR}}/
